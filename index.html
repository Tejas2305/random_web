<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <title>Multi Audio Viewer</title>
    <style>
        .device { margin-bottom: 20px; }
        .level-bar {
            width: 100%;
            height: 10px;
            background: #eee;
        }
        .level-fill {
            height: 100%;
            background: green;
            width: 0%;
        }
    </style>
</head>
<body>
    <h1>Audio Devices</h1>
    <div id="devices"></div>

    <script>
        async function fetchDeviceList() {
            const ws = new WebSocket("ws://localhost:8765");
            ws.onmessage = (event) => {
                const devices = JSON.parse(event.data);
                devices.forEach(createDevicePlayer);
            };
        }

        function createDevicePlayer({ name, port }) {
            const container = document.createElement("div");
            container.className = "device";

            const title = document.createElement("h3");
            title.textContent = name;

            const levelBar = document.createElement("div");
            levelBar.className = "level-bar";
            const fill = document.createElement("div");
            fill.className = "level-fill";
            levelBar.appendChild(fill);

            const muteBtn = document.createElement("button");
            muteBtn.textContent = "Mute";
            let isMuted = false;

            let gainNode, audioContext, source;

            const ws = new WebSocket(`ws://localhost:${port}`);
            ws.binaryType = "arraybuffer";

            ws.onmessage = (e) => {
                if (!audioContext) {
                    audioContext = new AudioContext();
                    gainNode = audioContext.createGain();
                    gainNode.connect(audioContext.destination);
                }

                const int16Array = new Int16Array(e.data);
                const float32Array = new Float32Array(int16Array.length);
                let maxAmp = 0;
                for (let i = 0; i < int16Array.length; i++) {
                    const sample = int16Array[i] / 32768.0;
                    float32Array[i] = sample;
                    maxAmp = Math.max(maxAmp, Math.abs(sample));
                }

                fill.style.width = `${Math.min(100, maxAmp * 100)}%`;

                const buffer = audioContext.createBuffer(1, float32Array.length, 44100);
                buffer.copyToChannel(float32Array, 0);
                source = audioContext.createBufferSource();
                source.buffer = buffer;
                source.connect(gainNode);
                source.start();
            };

            muteBtn.onclick = () => {
                isMuted = !isMuted;
                if (gainNode) gainNode.gain.value = isMuted ? 0 : 1;
                muteBtn.textContent = isMuted ? "Unmute" : "Mute";
            };

            container.appendChild(title);
            container.appendChild(muteBtn);
            container.appendChild(levelBar);
            document.getElementById("devices").appendChild(container);
        }

        fetchDeviceList();
    </script>
</body>
</html>
